var u=Object.defineProperty;var m=(d,p)=>u(d,"name",{value:p,configurable:!0});(()=>{"use strict";var d={};class p{constructor(t){this.url,this.protocol="http:",this.hostname="",this.port=80,this.pathname="/",this.queryString="",t?this.opts=t:this.opts={encodeURI:!1,timeout:8e3,responseType:"",retry:3,retryDelay:5500,maxRedirects:3,headers:{authorization:"",accept:"*/*"}},this.timeout=this.opts.timeout,this.responseType=this.opts.responseType,this.req_headers={...this.opts.headers},this.xhr=new XMLHttpRequest,this.interceptor}async askOnce(t,e="GET",r){const s={requestURL:t,requestMethod:e,status:0,statusMessage:"",https:!1,req:{headers:this.req_headers,payload:void 0},res:{headers:void 0,content:void 0},time:{req:this._getTime(),res:void 0,duration:void 0}};try{t=this._parseUrl(t),s.requestURL=t,s.https=/^https/.test(this.protocol)}catch(n){const a={...s};return a.status=400,a.statusMessage=n.message||"Bad Request",a.time.res=this._getTime(),a.time.duration=this._getTimeDiff(a.time.req,a.time.res),a}if(this.interceptor&&await this.interceptor(),this.xhr.open(e,t,!0,null,null),this._xhr_timeout(this.timeout),this._xhr_responseType(this.responseType),this._xhr_requestHeaders(this.req_headers),r&&!/GET/i.test(e)){s.req.payload=r;const n=this.req_headers["content-type"]||"";let a;/application\/json/.test(n)?a=JSON.stringify(r):a=r,this.xhr.send(a)}else this.xhr.send();return new Promise((n,a)=>{this.xhr.onload=i=>{const h={...s};h.status=this.xhr.status,h.statusMessage=this.xhr.statusText,h.res.headers=this.getResHeaders(),h.res.content=i.target.response,h.time.res=this._getTime(),h.time.duration=this._getTimeDiff(h.time.req,h.time.res),n(h)},this.xhr.onerror=i=>{this.kill();const h=this._formatError(i,t),c={...s};c.status=h.status,c.statusMessage=h.message,c.time.res=this._getTime(),c.time.duration=this._getTimeDiff(c.time.req,c.time.res),n(c)},this.xhr.ontimeout=()=>{this.kill();const i={...s};i.status=408,i.statusMessage=`Request aborted due to timeout (${this.opts.timeout} ms) ${t} `,i.time.res=this._getTime(),i.time.duration=this._getTimeDiff(i.time.req,i.time.res),n(i)},setTimeout(()=>{const i={...s};i.status=408,i.statusMessage=`Server did not respond and timeout is forced after ${this.timeout} ms.`,i.time.res=this._getTime(),i.time.duration=this._getTimeDiff(i.time.req,i.time.res),n(i)},this.timeout)})}async ask(t,e="GET",r){let s=await this.askOnce(t,e,r);const o=[s];let n=1;for(;s&&/^3\d{2}/.test(s.status)&&n<=this.opts.maxRedirects;){const i=new URL(t,s.res.headers.location);console.log(`#${n} redirection ${s.status} from ${this.url} to ${i}`),s=await this.askOnce(i,e,r),o.push(s),n++}let a=1;for(;s.status===408&&a<=this.opts.retry;)console.log(`#${a} retry due to timeout (${this.opts.timeout}) on ${t}`),await new Promise(i=>setTimeout(i,this.opts.retryDelay)),s=await this.askOnce(t,e,r),o.push(s),a++;return o}async askJSON(t,e="GET",r){let s=r;if(r&&typeof r=="string")try{s=JSON.parse(r)}catch{throw new Error("Body string is not valid JSON.")}this.setReqHeaders({accept:"application/json","content-type":"application/json; charset=utf-8"});const o=await this.askOnce(t,e,s);if(o.res.content)try{o.res.content=JSON.parse(o.res.content)}catch{throw new Error("Response content is not valid JSON.")}return o}async askHTML(t){return this.setReqHeaders({accept:"text/html","content-type":"text/html"}),await this.askOnce(t,"GET")}async askJS(t){return this.setReqHeaders({accept:"application/javascript","content-type":"application/javascript; charset=utf-8"}),await this.askOnce(t,"GET")}async sendFormData(t,e){this.setReqHeaders({accept:"*/*","content-type":"multipart/form-data"}),this.delReqHeaders(["content-type"]);const r=await this.askOnce(t,"POST",e);if(r.res.content)try{r.res.content=JSON.parse(r.res.content)}catch{console.log("WARNING: Response content is not JSON.")}return r}object2formdata(t){const e=new FormData;for(const[r,s]of Object.entries(t))e.set(r,s);return e}async sendForm(t,e,r="application/x-www-form-urlencoded"){let s="DodoWebHttpClient";s+=Math.floor(Math.random()*32768),s+=Math.floor(Math.random()*32768),s+=Math.floor(Math.random()*32768),console.log("boundary::",s);const o=`--${s}\r
Content-Disposition: form-data; name="db_id"\r
\r
12345\r
--${s}--`;return console.log("body::",o),await this.askOnce(t,"POST",e)}kill(){this.xhr.abort()}setInterceptor(t){this.interceptor=t.bind(this)}setReqHeaders(t){Object.keys(t).forEach(e=>{const r=e,s=t[e];this.setReqHeader(r,s)})}setReqHeader(t,e){t=t.toLowerCase(),this.req_headers[t]=e}delReqHeaders(t){t.forEach(e=>{delete this.req_headers[e]})}getReqHeaders(){return this.req_headers}getResHeaders(){const e=this.xhr.getAllResponseHeaders().split(`
`),r={};return e.forEach(s=>{const o=s.split(":"),n=o[0];if(n){const a=o[1].trim();r[n]=a}}),r}_parseUrl(t){t=this._correctUrl(t);const e=new URL(t);return this.url=t,this.protocol=e.protocol,this.hostname=e.hostname,this.port=e.port,this.pathname=e.pathname,this.queryString=e.search,t}_correctUrl(t){if(!t)throw new Error("URL is not defined");return t=t.trim(),/^https?:\/\//.test(t)||(t="http://"+t),this.opts.encodeURI?t=encodeURI(t):(t=t.replace(/\s+/g," "),t=t.replace(/ /g,"%20")),t}_formatError(t,e){const r=new Error(t);return t.target.status===0?(r.status=0,r.message=`Status:0 Bad Request ${e}`):(r.status=t.status||400,r.message=t.message),r.original=t,r}_getTime(){return new Date().toISOString()}_getTimeDiff(t,e){const r=new Date(t);return(new Date(e).getTime()-r.getTime())/1e3}_xhr_requestHeaders(t){Object.keys(t).forEach(e=>this.xhr.setRequestHeader(e.toLowerCase(),t[e]))}_xhr_timeout(t){this.xhr.timeout=+t||0}_xhr_responseType(t){this.xhr.responseType=t||"text"}}m(p,"HTTPClientBroXHR");var f=null;typeof window<"u"&&(window.mikosoft||(window.mikosoft={}),window.mikosoft.HTTPClientBroXHR=p)})();

//# sourceMappingURL=httpclient-bro-xhr.min.js.map